# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1A6nYUyOabSo3lhooiVweSj0sbW2zrhqa
"""

import pandas as pd
from datetime import datetime
import streamlit as st
import os

# Configuración de la página
st.set_page_config(page_title="Consulta de Defensas", page_icon="🎓")

# Cargar los datos con manejo de errores
@st.cache_data
def load_data():
    try:
        # Intenta primero con openpyxl
        try:
            df = pd.read_excel('Separador en Python.xlsx', 
                             dtype={'CEDULA': str}, 
                             engine='openpyxl')
        except:
            # Fallback a xlrd si openpyxl falla
            df = pd.read_excel('Separador en Python.xlsx', 
                             dtype={'CEDULA': str}, 
                             engine='xlrd')
            
        df['FECHA SIMPLE'] = pd.to_datetime(df['FECHA SIMPLE'])
        return df
    except Exception as e:
        st.error(f"Error al cargar el archivo: {str(e)}")
        st.error("Por favor verifique que el archivo 'Separador en Python.xlsx' existe y tiene el formato correcto.")
        return None

df = load_data()

# Función de consulta
def consultar_defensa(cedula):
    if df is None:
        return None, "Error en los datos. Contacte al administrador."
    
    estudiante = df[df['CEDULA'].str.strip() == cedula.strip()]
    
    if estudiante.empty:
        return None, "No se encontró ningún estudiante con esa cédula."
    
    datos = estudiante.iloc[0]
    hoy = datetime.now().strftime('%Y-%m-%d')
    fecha_defensa = datos['FECHA SIMPLE'].strftime('%Y-%m-%d')
    
    info = {
        'nombre': datos['APELLIDOS Y NOMBRES '],
        'opcion': datos['OPCION DE TITULACIÓN\nEX. COM./TIC/TT'],
        'fecha': datos['FECHA SIMPLE'].strftime('%d/%m/%Y'),
        'hora': datos['HORA'],
        'enlace': datos['ENLACES'],
        'hoy': fecha_defensa == hoy
    }
    
    return info, None

# Interfaz de usuario
st.title("🎓 Sistema de Consulta de Defensas de Titulación")

cedula = st.text_input("Ingrese su número de cédula (solo números):", max_chars=10)

if st.button("Consultar"):
    if cedula:
        info, error = consultar_defensa(cedula)
        
        if error:
            st.error(error)
        else:
            st.success("Información encontrada:")
            st.subheader(info['nombre'])
            st.write(f"**Opción de titulación:** {info['opcion']}")
            
            if info['hoy']:
                st.write(f"**Fecha de defensa:** {info['fecha']}")
                st.write(f"**Hora:** {info['hora']}")
                st.write(f"**Enlace:** [Click aquí]({info['enlace']})")
                st.balloons()
            else:
                st.warning(f"No tienes programada una defensa para hoy. Tu defensa es el {info['fecha']}")
    else:
        st.warning("Por favor ingrese su número de cédula")

st.markdown("---")
st.caption("Sistema de consulta de defensas - Universidad XYZ")
